<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Test - J√≥venes con Cristo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #4f46e5;
            text-align: center;
            margin-bottom: 30px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .status.info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #4338ca;
        }

        .console {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .console-entry {
            margin: 2px 0;
        }

        .console-error {
            color: #ef4444;
        }

        .console-warn {
            color: #f59e0b;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
        }

        .test-section h3 {
            margin-top: 0;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Service Worker Test</h1>

        <div id="status-container"></div>

        <div class="test-section">
            <h3>Service Worker Tests</h3>
            <button onclick="testSWRegistration()">Test SW Registration</button>
            <button onclick="testCacheStatus()">Check Cache Status</button>
            <button onclick="testBibleLoading()">Test Bible Loading</button>
            <button onclick="clearConsole()">Clear Console</button>
        </div>

        <div class="test-section">
            <h3>Environment Info</h3>
            <div id="env-info"></div>
        </div>

        <div class="console">
            <div id="console-output"></div>
        </div>
    </div>

    <script>
        // Custom console to capture output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        const consoleOutput = document.getElementById('console-output');

        function addToConsole(message, type = 'log') {
            const entry = document.createElement('div');
            entry.className = `console-entry console-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;

            // Also log to original console
            originalConsole[type](message);
        }

        // Override console methods
        console.log = (message) => addToConsole(message, 'log');
        console.error = (message) => addToConsole(message, 'error');
        console.warn = (message) => addToConsole(message, 'warn');

        // Status functions
        function addStatus(message, type = 'info') {
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            document.getElementById('status-container').appendChild(status);
        }

        function clearStatus() {
            document.getElementById('status-container').innerHTML = '';
        }

        // Environment info
        function showEnvironmentInfo() {
            const envInfo = document.getElementById('env-info');
            envInfo.innerHTML = `
                <strong>Host:</strong> ${window.location.hostname}<br>
                <strong>Path:</strong> ${window.location.pathname}<br>
                <strong>Protocol:</strong> ${window.location.protocol}<br>
                <strong>SW Support:</strong> ${'serviceWorker' in navigator ? '‚úÖ Yes' : '‚ùå No'}<br>
                <strong>Cache Support:</strong> ${'caches' in window ? '‚úÖ Yes' : '‚ùå No'}
            `;
        }

        // Test functions
        async function testSWRegistration() {
            clearStatus();
            console.log('üîß Testing Service Worker Registration...');

            if (!('serviceWorker' in navigator)) {
                addStatus('‚ùå Service Workers not supported', 'error');
                return;
            }

            addStatus('‚úÖ Service Workers supported', 'success');

            // Get current environment info
            const currentHost = window.location.hostname;
            const currentPath = window.location.pathname;
            console.log(`üåê Environment: ${currentHost}${currentPath}`);

            // Determine expected SW path
            let expectedSwPath = '/sw.js'; // Default
            if (currentHost.includes('github.io') || currentPath.includes('/JovenesIBEC')) {
                expectedSwPath = '/JovenesIBEC/sw.js';
            }
            console.log(`üìÅ Expected SW path: ${expectedSwPath}`);

            try {
                // Check existing registrations
                const registrations = await navigator.serviceWorker.getRegistrations();
                console.log(`üìã Existing registrations: ${registrations.length}`);
                registrations.forEach(reg => {
                    console.log(`  - Scope: ${reg.scope}`);
                    console.log(`  - State: ${reg.active ? reg.active.state : 'inactive'}`);
                });

                // Try to register
                const registration = await navigator.serviceWorker.register(expectedSwPath);
                console.log('‚úÖ Service Worker registered successfully!');
                console.log(`üìç Scope: ${registration.scope}`);

                addStatus('‚úÖ Service Worker registered successfully!', 'success');

                // Listen for updates
                registration.addEventListener('updatefound', () => {
                    console.log('üîÑ Service Worker update found');
                    addStatus('üîÑ Service Worker update available', 'info');
                });

            } catch (error) {
                console.error('‚ùå Registration failed:', error);
                addStatus(`‚ùå Registration failed: ${error.message}`, 'error');
            }
        }

        async function testCacheStatus() {
            clearStatus();
            console.log('üíæ Checking Cache Status...');

            if (!('caches' in window)) {
                addStatus('‚ùå Cache API not supported', 'error');
                return;
            }

            try {
                const cacheNames = await caches.keys();
                console.log(`üì¶ Cache names: ${cacheNames.join(', ')}`);

                for (const name of cacheNames) {
                    const cache = await caches.open(name);
                    const requests = await cache.keys();
                    console.log(`  üì¶ ${name}: ${requests.length} items`);
                }

                addStatus(`‚úÖ Found ${cacheNames.length} cache(s)`, 'success');

            } catch (error) {
                console.error('‚ùå Cache check failed:', error);
                addStatus(`‚ùå Cache check failed: ${error.message}`, 'error');
            }
        }

        async function testBibleLoading() {
            clearStatus();
            console.log('üìñ Testing Bible Loading...');

            if (typeof biblia === 'undefined') {
                addStatus('‚ùå Biblia object not loaded', 'error');
                return;
            }

            addStatus('‚úÖ Biblia object available', 'success');

            try {
                console.log('üìñ Loading Genesis 1...');
                const data = await biblia.obtenerCapitulo('G√©nesis', 1);

                if (data && Object.keys(data).length > 0) {
                    console.log(`‚úÖ Chapter loaded: ${Object.keys(data).length} verses`);
                    addStatus(`‚úÖ Bible chapter loaded (${Object.keys(data).length} verses)`, 'success');
                } else {
                    console.error('‚ùå Failed to load chapter');
                    addStatus('‚ùå Failed to load Bible chapter', 'error');
                }

            } catch (error) {
                console.error('‚ùå Bible loading error:', error);
                addStatus(`‚ùå Bible loading error: ${error.message}`, 'error');
            }
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showEnvironmentInfo();
            console.log('üèÅ Service Worker Test Page Loaded');
            addStatus('üèÅ Test page ready. Click buttons to run tests.', 'info');
        });
    </script>

    <!-- Load the Bible scripts -->
    <script src="1960.js"></script>
    <script src="biblia.js"></script>
</body>
</html>
